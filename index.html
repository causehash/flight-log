<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flight Log</title>
    <!-- jsPDF library for PDF export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --background-color: #000000;
            --text-color: #ffffff;
            --border-color: #4a4a4a;
            --focus-color: #007aff;
            --red-color: #ff3b30;
            --green-color: #34c759;
            --amber-color: #ff9500;
            --toolbar-bg: #1c1c1e;
            --button-bg: #3a3a3c;
            --subtle-text-color: #8e8e93;
            --navy-blue-bg: #000033;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            -webkit-text-size-adjust: none; /* Prevents text resizing on orientation change */
        }
        
        #main-app {
            display: none; /* Hidden by default until auth is ready to prevent flash of unstyled content */
        }

        #app-container {
            padding: 5px 5px 80px 5px; /* Padding to accommodate fixed toolbar at the bottom */
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-width: 800px;
            margin: 0 auto;
        }

        .data-section {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 10px 10px 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            position: relative;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        /* Special background for sectors 2, 4, 6 as per spec */
        .data-section.flight-data-odd-sector {
            background-color: var(--navy-blue-bg);
        }
        
        /* Title embedded in the top border of each section */
        .section-title {
            position: absolute;
            top: -11px; /* Position title over the border */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--background-color); /* Match body background to create cutout effect */
            padding: 0 8px;
            font-size: clamp(11px, 2.5vw, 13px);
            font-weight: bold;
            color: var(--text-color);
            white-space: nowrap;
        }
        
        label {
            font-size: clamp(9px, 2.2vw, 11px);
            margin-bottom: 0;
            color: var(--text-color); text-transform: uppercase;
            font-weight: 500; cursor: default;
            line-height: 1.2;
            min-height: 2.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .field-group {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; text-align: center;
            min-width: 0; padding: 0 1px;
        }
        
        .field-value, .calculated, select.field-value {
            background-color: transparent; border: none;
            color: var(--text-color); text-align: center;
            width: 98%; padding: 1px 0;
            font-size: clamp(14px, 3.5vw, 18px);
            text-transform: uppercase; border-radius: 4px;
            font-weight: 600;
            -moz-appearance: none; -webkit-appearance: none; appearance: none;
            font-family: inherit;
        }

        /* Specific styling for certain fields */
        #date.field-value::placeholder { color: var(--text-color); opacity: 1; font-size: clamp(12px, 3vw, 14px); }
        #cic.field-value, #fo.field-value { font-size: clamp(10px, 2.5vw, 12px); }
        select.field-value { text-align-last: center; }
        input:focus, select:focus, textarea:focus { background-color: var(--border-color); outline: 2px solid var(--focus-color); }
        .sub-field-value { padding: 0; min-height: 1em; line-height: 1; font-size: clamp(9px, 2vw, 11px); color: var(--subtle-text-color); }

        /* --- Section 1: FLIGHT DATA --- */
        #flight-data-section { flex-wrap: nowrap; justify-content: space-around; gap: 2px; overflow-x: auto; }
        #flight-data-section > .field-group { flex: 1 1 60px; min-width: 55px; }
        .input-with-tz { display: flex; flex-direction: column; align-items: center; width: 100%;}
        .timezone-input { font-size: 9px; color: var(--subtle-text-color); height: 11px; pointer-events: none; user-select: none; background: transparent; border: none; text-align: center; width: 100%; }

        /* --- Section 2: TIMINGS --- */
        .timings-section { flex-direction: column; gap: 0; padding-bottom: 5px; }
        .timings-row, .timings-sub-row { display:flex; width:100%; justify-content: space-between; align-items: flex-start; }
        .timings-row > .field-group > label { min-height: 1.2em; padding-bottom: 3px; }
        .timings-sub-row { font-size: 12px; min-height: 20px; }
        .main-time-field { font-size: clamp(16px, 4vw, 20px); font-weight: 700; }
        .timings-sub-row .field-group { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 24px; }
        
        /* --- Section 3: FLIGHT PLANNING --- */
        .flight-planning-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px 5px; align-items: start; }
        .flight-planning-section label { height: auto; }
        #egt-label { color: var(--subtle-text-color); }
        .weight-limit { color: var(--subtle-text-color); }
        .input-with-toggle { display: flex; align-items: center; justify-content: center; width:100%; gap: 2px;}
        .temp-toggle { height: 24px; width: 24px; font-size: 12px; background-color: transparent; border: none; color: var(--text-color); border-radius: 4px; padding: 0; flex-shrink: 0; cursor: pointer; }
        #crzTemp { flex-grow: 1; width: calc(100% - 26px); }
        .wide-field-group { grid-column: 1 / -1; }
        #remarks.field-value { min-height: calc(3 * 1.5em); padding: 5px; resize: vertical; border: 1px solid var(--border-color); text-align: left; white-space: pre-wrap; }
        
        /* --- Toolbar & Modals --- */
        #toolbar { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--toolbar-bg); padding: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        #user-id-display { position: fixed; top: 8px; right: 8px; background-color: var(--button-bg); color: var(--text-color); padding: 4px 8px; border-radius: 8px; font-size: 11px; z-index: 101; }
        .sector-buttons { display: flex; gap: 4px; flex-grow: 1; }
        .action-buttons { display: flex; gap: 4px; flex-shrink: 0; }
        #toolbar button { background-color: var(--button-bg); color: var(--text-color); border: none; padding: 8px 12px; border-radius: 8px; font-size: clamp(12px, 3vw, 14px); font-weight: 600; cursor: pointer; white-space: nowrap; }
        .sector-buttons button { flex-grow: 1; }
        #toolbar button.active { background-color: var(--focus-color); }
        #sign-out-btn { background-color: var(--red-color); }
        #export-pdf-btn { background-color: var(--green-color); }

        /* --- Delay Section --- */
        #delay-codes-container details { margin-top: 10px; }
        #delay-codes-container summary { font-weight: bold; cursor: pointer; }
        .delay-code-item { padding: 2px 0 2px 15px; font-size: clamp(11px, 2.5vw, 13px); text-align: left; }
        #quick-ref-container { width: 100%; margin-bottom: 10px; }
        #quick-ref-delays-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0 10px; }
        #quick-ref-title { margin: 0 0 5px 0; font-size: clamp(10px, 2.2vw, 12px); text-align: center; }

        /* --- Modal Styling --- */
        .modal-textarea { width: 100%; height: 150px; background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 14px; padding: 5px; }
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--toolbar-bg); margin: 15% auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; width: 80%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        .modal-content button { background-color: var(--focus-color); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; align-self: flex-end; }
        .modal-trigger.field-value { cursor: pointer; }
    </style>
</head>
<body>

    <div id="main-app">
        <div id="user-id-display">Connecting...</div>
        <div id="app-container">
            <!-- SECTION 1: FLIGHT DATA -->
            <section id="flight-data-section" class="data-section">
                <h2 class="section-title">FLIGHT DATA</h2>
                <div class="field-group"><label for="flightNumber">FLT NO.</label><input type="text" id="flightNumber" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="date" id="date-label">DATE</label><input type="text" id="date" class="field-value" placeholder=""></div>
                <div class="field-group"><label for="from">FROM</label><div class="input-with-tz"><input type="text" id="from" class="field-value" maxlength="3"><input type="text" id="from-tz" class="timezone-input" readonly></div></div>
                <div class="field-group"><label for="to">TO</label><div class="input-with-tz"><input type="text" id="to" class="field-value" maxlength="3"><input type="text" id="to-tz" class="timezone-input" readonly></div></div>
                <div class="field-group"><label for="cic">CIC</label><input type="text" id="cic" class="field-value"></div>
                <div class="field-group"><label for="fo">FO</label><input type="text" id="fo" class="field-value"></div>
                <div class="field-group"><label for="registration">REG</label><input type="text" id="registration" class="field-value" maxlength="3"></div>
                <div class="field-group"><label for="report">RPT</label><input type="text" id="report" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="depGate">DEP GATE</label><input type="text" id="depGate" class="field-value" maxlength="5"></div>
            </section>

            <!-- SECTION 2: TIMINGS -->
            <section class="data-section timings-section">
                <h2 class="section-title">TIMINGS</h2>
                <div class="timings-row">
                    <div class="field-group"><label for="out">OUT</label><input type="text" id="out" class="field-value main-time-field" inputmode="numeric"></div>
                    <div class="field-group"><label for="taxi">TAXI</label><input type="text" id="taxi" class="field-value main-time-field" inputmode="numeric"></div>
                    <div class="field-group"><label for="off">OFF</label><input type="text" id="off" class="field-value main-time-field" inputmode="numeric"></div>
                    <div class="field-group"><label for="on">ON</label><input type="text" id="on" class="field-value main-time-field" inputmode="numeric"></div>
                    <div class="field-group"><label for="in">IN</label><input type="text" id="in" class="field-value main-time-field" inputmode="numeric"></div>
                </div>
                <div class="timings-sub-row">
                    <div class="field-group"><div id="ddd" class="sub-field-value"></div></div>
                    <div class="field-group"><div id="tod" class="sub-field-value"></div></div>
                    <div class="field-group"></div>
                    <div class="field-group"><div id="tid" class="sub-field-value"></div></div>
                    <div class="field-group"><div id="aaa" class="sub-field-value"></div></div>
                </div>
                 <div class="timings-sub-row">
                    <div class="field-group"><div id="cddd" class="sub-field-value"></div><div id="addd" class="sub-field-value"></div><div id="conseq-avail-group" class="sub-field-value"></div></div>
                    <div class="field-group"></div><div class="field-group"></div>
                    <div class="field-group"></div>
                    <div class="field-group"><div id="caaa" class="sub-field-value"></div><div id="aaaa" class="sub-field-value"></div></div>
                </div>
                <div class="timings-row">
                    <div class="field-group"><label for="std">SCHEDULED OUT</label><input type="text" id="std" class="field-value main-time-field" inputmode="numeric"></div>
                    <div class="field-group"><label for="eft">FLIGHT TIME</label><input type="text" id="eft" class="field-value main-time-field" inputmode="numeric"></div>
                    <div class="field-group"><label>BLOCK</label><div id="blk" class="field-value calculated main-time-field"></div></div>
                    <div class="field-group"><label for="sta">SCHEDULED IN</label><input type="text" id="sta" class="field-value main-time-field" inputmode="numeric"></div>
                </div>
                <div class="timings-sub-row">
                    <div class="field-group"><div id="stdl" class="sub-field-value"></div></div>
                    <div class="field-group"><div id="aft" class="sub-field-value"></div><div id="aftd" class="sub-field-value"></div></div>
                    <div class="field-group"><div id="abt" class="sub-field-value"></div><div id="abtd" class="sub-field-value"></div></div>
                    <div class="field-group"><div id="stal" class="sub-field-value"></div></div>
                </div>
            </section>

            <!-- SECTION 3: FLIGHT PLANNING -->
            <section class="data-section flight-planning-section">
                <h2 class="section-title">FLIGHT PLANNING</h2>
                <div class="field-group"><label for="pln">PLN</label><input type="text" id="pln" class="field-value" inputmode="numeric" maxlength="3"></div>
                <div class="field-group"><label for="ezfw1">EZFW 1</label><input type="text" id="ezfw1" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="ezfw2">EZFW 2</label><input type="text" id="ezfw2" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="azfw">AZFW</label><input type="text" id="azfw" class="field-value" inputmode="numeric"><div id="mzfw" class="sub-field-value weight-limit"></div></div>
                <div class="field-group"><label for="ptow">PTOW</label><div id="ptow" class="calculated"></div><div id="mtow" class="sub-field-value weight-limit"></div></div>
                <div class="field-group"><label id="plw-label" for="plw">PLW</label><div id="plw" class="calculated"></div><div id="mlw" class="sub-field-value weight-limit"></div></div>
                
                <div class="field-group"><label for="fuel">FUEL</label><input type="text" id="fuel" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="burn">BURN</label><input type="text" id="burn" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="cont">CONT</label><input type="text" id="cont" class="field-value" inputmode="numeric" maxlength="1"></div>
                <div class="field-group"><label for="altn">ALTN</label><input type="text" id="altn" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="thirtyMin">30 MIN</label><input type="text" id="thirtyMin" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label id="egt-label">MAX EGT</label><div id="egt" class="calculated weight-limit"></div></div>
                
                <div class="field-group"><label for="crzWind">CRZ WND</label><input type="text" id="crzWind" class="field-value" inputmode="numeric"></div>
                <div class="field-group">
                    <label for="crzTemp">CRZ TMP</label>
                    <div class="input-with-toggle">
                        <input type="text" id="crzTemp" class="field-value" inputmode="numeric" maxlength="2">
                        <button id="crzTempToggle" class="temp-toggle">M</button>
                    </div>
                </div>
                <div class="field-group"><label for="opti1">OPTI 1</label><input type="text" id="opti1" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="opti2">OPTI 2</label><input type="text" id="opti2" class="field-value" inputmode="numeric"></div>
                <div class="field-group"><label for="apd">APD</label><input type="text" id="apd" class="field-value" inputmode="numeric"></div>
                
                <div class="field-group wide-field-group"><label for="afir">AFIR</label><input type="text" id="afir" class="field-value modal-trigger" readonly></div>
                <div class="field-group wide-field-group"><label for="notam">NOTAM</label><input type="text" id="notam" class="field-value modal-trigger" readonly></div>
                <div class="field-group wide-field-group"><label for="defects">DEFECTS</label><input type="text" id="defects" class="field-value modal-trigger" readonly></div>
                <div class="field-group wide-field-group"><label for="remarks">REMARKS</label><textarea id="remarks" class="field-value"></textarea></div>
            </section>

            <!-- SECTION 4: DELAY ATTRIBUTION -->
            <section class="data-section" style="flex-direction: column;">
                <h2 class="section-title">DELAY ATTRIBUTION</h2>
                 <div id="quick-ref-container">
                    <h3 id="quick-ref-title">QUICK REFERENCE DELAYS</h3>
                    <div id="quick-ref-delays-container"></div>
                </div>
                <div id="delay-codes-container"></div>
            </section>
        </div>

        <!-- TOOLBAR -->
        <div id="toolbar">
            <div class="sector-buttons">
                <button class="sector-btn" data-sector="0">1</button>
                <button class="sector-btn" data-sector="1">2</button>
                <button class="sector-btn" data-sector="2">3</button>
                <button class="sector-btn" data-sector="3">4</button>
                <button class="sector-btn" data-sector="4">5</button>
                <button class="sector-btn" data-sector="5">6</button>
            </div>
            <div class="action-buttons">
                <button id="clear-sector-btn">CLEAR SECTOR</button>
                <button id="clear-all-btn">CLEAR ALL</button>
                <button id="sign-out-btn">Sign Out</button>
                <button id="export-pdf-btn">EXPORT</button>
            </div>
        </div>

        <!-- MODALS -->
        <div id="afir-modal" class="modal"><div class="modal-content"><h2>AFIR Details</h2><textarea id="afir-textarea" class="modal-textarea"></textarea><button>Save & Close</button></div></div>
        <div id="notam-modal" class="modal"><div class="modal-content"><h2>NOTAM Details</h2><textarea id="notam-textarea" class="modal-textarea"></textarea><button>Save & Close</button></div></div>
        <div id="defects-modal" class="modal"><div class="modal-content"><h2>Defects</h2><textarea id="defects-textarea" class="modal-textarea"></textarea><button>Save & Close</button></div></div>
    </div>
    
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Data ---
        let flightData, currentSectorIndex = 0, userId, flightLogDocRef, unsubscribe;
        let auth, db, ui = {}; // Firebase services and UI elements cache

        // --- Embedded Data Schemas (as per spec) ---
        const aircraftLimits = { "MAX": { "MZFW": 65.9, "MTOW": 82.1, "MLW": 69.3, "EGT": "753°C" }, "NG": { "MZFW": 62.7, "MTOW": 79.0, "MLW": 66.3, "EGT": "725°C" } };
        const iataTimezones = {"SIN":"+8","KUL":"+8","BKK":"+7","CGK":"+7","DPS":"+8","SGN":"+7","HAN":"+7","MNL":"+8","HKG":"+8","TPE":"+8","PVG":"+8","PEK":"+8","CAN":"+8","NRT":"+9","HND":"+9","KIX":"+9","ICN":"+9","PEN":"+8","BWN":"+8","KTI":"+7","SAI":"+7","DAD":"+7","DRW":"+9.5","KTM":"+5.75","BLR":"+5.5","CCU":"+5.5","HYD":"+5.5","MAA":"+5.5","COK":"+5.5","PUS":"+9","HKT":"+7","RGN":"+6.5","CEB":"+8","SUB":"+7","KNO":"+7","BOM":"+5.5","DEL":"+5.5","DAC":"+6","CMB":"+5.5","MLE":"+5","SYD":"+10","MEL":"+10","BNE":"+10","PER":"+8","ADL":"+9.5","AKL":"+12","CHC":"+12","DXB":"+4","AUH":"+4","DOH":"+3","JED":"+3","RUH":"+3","LHR":"+1","CDG":"+2","FRA":"+2","MUC":"+2","ZRH":"+2","AMS":"+2","FCO":"+2","MXP":"+2","BCN":"+2","CPH":"+2","IST":"+3","JFK":"-4","LAX":"-7","SFO":"-7","SEA":"-7","IAH":"-5","EWR":"-4","CPT":"+2","JNB":"+2", "CNS":"+10", "MAN":"+1", "BRU":"+2", "LGW":"+1", "AMD":"+5.5", "PKX":"+8", "TFU":"+8", "SZX":"+8", "XMN":"+8"};
        const flightNumberRoutes = {"104":{"from":"SIN","to":"KUL"},"103":{"from":"KUL","to":"SIN"},"114":{"from":"SIN","to":"KUL"},"113":{"from":"KUL","to":"SIN"},"116":{"from":"SIN","to":"KUL"},"115":{"from":"KUL","to":"SIN"},"128":{"from":"SIN","to":"KUL"},"127":{"from":"KUL","to":"SIN"},"132":{"from":"SIN","to":"PEN"},"131":{"from":"PEN","to":"SIN"},"134":{"from":"SIN","to":"PEN"},"133":{"from":"PEN","to":"SIN"},"136":{"from":"SIN","to":"PEN"},"135":{"from":"PEN","to":"SIN"},"138":{"from":"SIN","to":"PEN"},"137":{"from":"PEN","to":"SIN"},"142":{"from":"SIN","to":"PEN"},"141":{"from":"PEN","to":"SIN"},"148":{"from":"SIN","to":"BWN"},"147":{"from":"BWN","to":"SIN"},"154":{"from":"SIN","to":"KTI"},"153":{"from":"KTI","to":"SIN"},"156":{"from":"SIN","to":"KTI"},"155":{"from":"KTI","to":"SIN"},"158":{"from":"SIN","to":"KTI"},"157":{"from":"KTI","to":"SIN"},"164":{"from":"SIN","to":"SAI"},"163":{"from":"SAI","to":"SIN"},"166":{"from":"SIN","to":"SAI"},"165":{"from":"SAI","to":"SIN"},"172":{"from":"SIN","to":"DAD"},"171":{"from":"DAD","to":"SIN"},"174":{"from":"SIN","to":"DAD"},"173":{"from":"DAD","to":"SIN"},"194":{"from":"SIN","to":"HAN"},"193":{"from":"HAN","to":"SIN"},"251":{"from":"SIN","to":"DRW"},"252":{"from":"DRW","to":"SIN"},"253":{"from":"SIN","to":"DRW"},"254":{"from":"DRW","to":"SIN"},"442":{"from":"SIN","to":"KTM"},"441":{"from":"KTM","to":"SIN"},"508":{"from":"SIN","to":"BLR"},"509":{"from":"BLR","to":"SIN"},"516":{"from":"SIN","to":"CCU"},"517":{"from":"CCU","to":"SIN"},"518":{"from":"SIN","to":"HYD"},"519":{"from":"HYD","to":"SIN"},"524":{"from":"SIN","to":"MAA"},"525":{"from":"MAA","to":"SIN"},"534":{"from":"SIN","to":"COK"},"535":{"from":"COK","to":"SIN"},"536":{"from":"SIN","to":"COK"},"537":{"from":"COK","to":"SIN"},"616":{"from":"SIN","to":"PUS"},"615":{"from":"PUS","to":"SIN"},"724":{"from":"SIN","to":"HKT"},"723":{"from":"HKT","to":"SIN"},"726":{"from":"SIN","to":"HKT"},"725":{"from":"HKT","to":"SIN"},"728":{"from":"SIN","to":"HKT"},"727":{"from":"HKT","to":"SIN"},"732":{"from":"SIN","to":"HKT"},"731":{"from":"HKT","to":"SIN"},"736":{"from":"SIN","to":"HKT"},"735":{"from":"HKT","to":"SIN"},"740":{"from":"SIN","to":"HKT"},"739":{"from":"HKT","to":"SIN"},"762":{"from":"SIN","to":"RGN"},"761":{"from":"RGN","to":"SIN"},"900":{"from":"SIN","to":"CEB"},"901":{"from":"CEB","to":"SIN"},"902":{"from":"SIN","to":"CEB"},"903":{"from":"CEB","to":"SIN"},"926":{"from":"SIN","to":"SUB"},"927":{"from":"SUB","to":"SIN"},"928":{"from":"SIN","to":"SUB"},"929":{"from":"SUB","to":"SIN"},"946":{"from":"SIN","to":"DPS"},"947":{"from":"DPS","to":"SIN"},"948":{"from":"SIN","to":"DPS"},"949":{"from":"DPS","to":"SIN"},"990":{"from":"SIN","to":"KNO"},"991":{"from":"KNO","to":"SIN"},"994":{"from":"SIN","to":"KNO"},"995":{"from":"KNO","to":"SIN"},"12":{"from":"SIN","to":"NRT"},"11":{"from":"LAX","to":"NRT"},"22":{"from":"SIN","to":"EWR"},"21":{"from":"EWR","to":"SIN"},"24":{"from":"SIN","to":"JFK"},"23":{"from":"JFK","to":"SIN"},"26":{"from":"SIN","to":"FRA"},"25":{"from":"JFK","to":"FRA"},"28":{"from":"SIN","to":"SEA"},"27":{"from":"SEA","to":"SIN"},"32":{"from":"SIN","to":"SFO"},"31":{"from":"SFO","to":"SIN"},"34":{"from":"SIN","to":"SFO"},"33":{"from":"SFO","to":"SIN"},"36":{"from":"SIN","to":"LAX"},"35":{"from":"LAX","to":"SIN"},"38":{"from":"SIN","to":"LAX"},"37":{"from":"LAX","to":"SIN"},"52":{"from":"SIN","to":"MAN"},"51":{"from":"IAH","to":"MAN"},"106":{"from":"SIN","to":"KUL"},"105":{"from":"KUL","to":"SIN"},"108":{"from":"SIN","to":"KUL"},"107":{"from":"KUL","to":"SIN"},"122":{"from":"SIN","to":"KUL"},"121":{"from":"KUL","to":"SIN"},"126":{"from":"SIN","to":"KUL"},"125":{"from":"KUL","to":"SIN"},"178":{"from":"SIN","to":"SGN"},"177":{"from":"SGN","to":"SIN"},"184":{"from":"SIN","to":"SGN"},"183":{"from":"SGN","to":"SIN"},"186":{"from":"SIN","to":"SGN"},"185":{"from":"SGN","to":"SIN"},"192":{"from":"SIN","to":"HAN"},"191":{"from":"HAN","to":"SIN"},"203":{"from":"SIN","to":"CNS"},"204":{"from":"CNS","to":"SIN"},"207":{"from":"SIN","to":"MEL"},"208":{"from":"MEL","to":"SIN"},"211":{"from":"SIN","to":"SYD"},"212":{"from":"SYD","to":"SIN"},"213":{"from":"SIN","to":"PER"},"214":{"from":"PER","to":"SIN"},"215":{"from":"SIN","to":"PER"},"216":{"from":"PER","to":"SIN"},"217":{"from":"SIN","to":"MEL"},"218":{"from":"MEL","to":"SIN"},"220":{"from":"MEL","to":"SIN"},"221":{"from":"SIN","to":"SYD"},"232":{"from":"SYD","to":"SIN"},"223":{"from":"SIN","to":"PER"},"225":{"from":"SIN","to":"PER"},"224":{"from":"PER","to":"SIN"},"227":{"from":"SIN","to":"MEL"},"238":{"from":"MEL","to":"SIN"},"231":{"from":"SIN","to":"SYD"},"222":{"from":"SYD","to":"SIN"},"235":{"from":"SIN","to":"BNE"},"256":{"from":"BNE","to":"SIN"},"237":{"from":"SIN","to":"MEL"},"228":{"from":"MEL","to":"SIN"},"241":{"from":"SIN","to":"SYD"},"242":{"from":"SYD","to":"SIN"},"245":{"from":"SIN","to":"BNE"},"246":{"from":"BNE","to":"SIN"},"247":{"from":"SIN","to":"MEL"},"248":{"from":"MEL","to":"SIN"},"255":{"from":"SIN","to":"BNE"},"236":{"from":"BNE","to":"SIN"},"265":{"from":"SIN","to":"BNE"},"266":{"from":"BNE","to":"SIN"},"277":{"from":"SIN","to":"ADL"},"276":{"from":"ADL","to":"SIN"},"279":{"from":"SIN","to":"ADL"},"278":{"from":"ADL","to":"SIN"},"285":{"from":"SIN","to":"AKL"},"286":{"from":"AKL","to":"SIN"},"297":{"from":"SIN","to":"CHC"},"298":{"from":"CHC","to":"SIN"},"302":{"from":"SIN","to":"MAN"},"301":{"from":"MAN","to":"SIN"},"304":{"from":"SIN","to":"BRU"},"303":{"from":"BRU","to":"SIN"},"306":{"from":"SIN","to":"LHR"},"305":{"from":"LHR","to":"SIN"},"308":{"from":"SIN","to":"LHR"},"319":{"from":"LHR","to":"SIN"},"312":{"from":"SIN","to":"LGW"},"309":{"from":"LGW","to":"SIN"},"318":{"from":"SIN","to":"LHR"},"321":{"from":"LHR","to":"SIN"},"322":{"from":"SIN","to":"LHR"},"317":{"from":"LHR","to":"SIN"},"324":{"from":"SIN","to":"AMS"},"323":{"from":"AMS","to":"SIN"},"326":{"from":"SIN","to":"FRA"},"325":{"from":"FRA","to":"SIN"},"328":{"from":"SIN","to":"MUC"},"327":{"from":"MUC","to":"SIN"},"332":{"from":"SIN","to":"CDG"},"331":{"from":"CDG","to":"SIN"},"336":{"from":"SIN","to":"CDG"},"335":{"from":"CDG","to":"SIN"},"346":{"from":"SIN","to":"ZRH"},"345":{"from":"ZRH","to":"SIN"},"352":{"from":"SIN","to":"CPH"},"351":{"from":"CPH","to":"SIN"},"356":{"from":"SIN","to":"MXP"},"355":{"from":"MXP","to":"SIN"},"366":{"from":"SIN","to":"FCO"},"365":{"from":"FCO","to":"SIN"},"378":{"from":"SIN","to":"MXP"},"377":{"from":"MXP","to":"SIN"},"388":{"from":"SIN","to":"BCN"},"387":{"from":"BCN","to":"SIN"},"392":{"from":"SIN","to":"IST"},"391":{"from":"IST","to":"SIN"},"402":{"from":"SIN","to":"DEL"},"401":{"from":"DEL","to":"SIN"},"406":{"from":"SIN","to":"DEL"},"403":{"from":"DEL","to":"SIN"},"422":{"from":"SIN","to":"BOM"},"421":{"from":"BOM","to":"SIN"},"432":{"from":"SIN","to":"MLE"},"438":{"from":"SIN","to":"MLE"},"446":{"from":"SIN","to":"DAC"},"447":{"from":"DAC","to":"SIN"},"468":{"from":"SIN","to":"CMB"},"469":{"from":"CMB","to":"SIN"},"478":{"from":"SIN","to":"JNB"},"479":{"from":"CPT","to":"JNB"},"482":{"from":"SIN","to":"JNB"},"481":{"from":"JNB","to":"SIN"},"494":{"from":"SIN","to":"DXB"},"495":{"from":"DXB","to":"SIN"},"504":{"from":"SIN","to":"AMD"},"505":{"from":"AMD","to":"SIN"},"510":{"from":"SIN","to":"BLR"},"511":{"from":"BLR","to":"SIN"},"522":{"from":"SIN","to":"HYD"},"523":{"from":"HYD","to":"SIN"},"528":{"from":"SIN","to":"MAA"},"529":{"from":"MAA","to":"SIN"},"600":{"from":"SIN","to":"ICN"},"601":{"from":"ICN","to":"SIN"},"606":{"from":"SIN","to":"ICN"},"605":{"from":"ICN","to":"SIN"},"608":{"from":"SIN","to":"ICN"},"607":{"from":"ICN","to":"SIN"},"612":{"from":"SIN","to":"ICN"},"611":{"from":"ICN","to":"SIN"},"618":{"from":"SIN","to":"KIX"},"619":{"from":"KIX","to":"SIN"},"620":{"from":"SIN","to":"KIX"},"621":{"from":"KIX","to":"SIN"},"622":{"from":"SIN","to":"KIX"},"623":{"from":"KIX","to":"SIN"},"632":{"from":"SIN","to":"HND"},"633":{"from":"HND","to":"SIN"},"634":{"from":"SIN","to":"HND"},"635":{"from":"HND","to":"SIN"},"636":{"from":"SIN","to":"HND"},"631":{"from":"HND","to":"SIN"},"638":{"from":"SIN","to":"NRT"},"637":{"from":"NRT","to":"SIN"},"656":{"from":"SIN","to":"FUK"},"655":{"from":"FUK","to":"SIN"},"672":{"from":"SIN","to":"NGO"},"671":{"from":"NGO","to":"SIN"},"706":{"from":"SIN","to":"BKK"},"705":{"from":"BKK","to":"SIN"},"708":{"from":"SIN","to":"BKK"},"707":{"from":"BKK","to":"SIN"},"710":{"from":"SIN","to":"BKK"},"709":{"from":"BKK","to":"SIN"},"712":{"from":"SIN","to":"BKK"},"711":{"from":"BKK","to":"SIN"},"714":{"from":"SIN","to":"BKK"},"713":{"from":"BKK","to":"SIN"},"720":{"from":"SIN","to":"BKK"},"719":{"from":"BKK","to":"SIN"},"800":{"from":"SIN","to":"PEK"},"805":{"from":"PEK","to":"SIN"},"802":{"from":"SIN","to":"PEK"},"807":{"from":"PEK","to":"SIN"},"806":{"from":"SIN","to":"PEK"},"801":{"from":"PEK","to":"SIN"},"810":{"from":"SIN","to":"PKX"},"811":{"from":"PKX","to":"SIN"},"818":{"from":"SIN","to":"CKG"},"819":{"from":"CKG","to":"SIN"},"826":{"from":"SIN","to":"PVG"},"827":{"from":"PVG","to":"SIN"},"828":{"from":"SIN","to":"PVG"},"831":{"from":"PVG","to":"SIN"},"830":{"from":"SIN","to":"PVG"},"833":{"from":"PVG","to":"SIN"},"836":{"from":"SIN","to":"PVG"},"825":{"from":"PVG","to":"SIN"},"842":{"from":"SIN","to":"TFU"},"843":{"from":"TFU","to":"SIN"},"850":{"from":"SIN","to":"CAN"},"851":{"from":"CAN","to":"SIN"},"852":{"from":"SIN","to":"CAN"},"853":{"from":"CAN","to":"SIN"},"856":{"from":"SIN","to":"SZX"},"857":{"from":"SZX","to":"SIN"},"868":{"from":"SIN","to":"XMN"},"869":{"from":"XMN","to":"SIN"},"874":{"from":"SIN","to":"HKG"},"875":{"from":"HKG","to":"SIN"},"876":{"from":"SIN","to":"TPE"},"877":{"from":"TPE","to":"SIN"},"878":{"from":"SIN","to":"TPE"},"879":{"from":"TPE","to":"SIN"},"882":{"from":"SIN","to":"HKG"},"883":{"from":"HKG","to":"SIN"},"892":{"from":"SIN","to":"HKG"},"893":{"from":"HKG","to":"SIN"},"894":{"from":"SIN","to":"HKG"},"895":{"from":"HKG","to":"SIN"},"898":{"from":"SIN","to":"HKG"},"899":{"from":"HKG","to":"SIN"},"910":{"from":"SIN","to":"MNL"},"917":{"from":"MNL","to":"SIN"},"912":{"from":"SIN","to":"MNL"},"919":{"from":"MNL","to":"SIN"},"916":{"from":"SIN","to":"MNL"},"921":{"from":"MNL","to":"SIN"},"918":{"from":"SIN","to":"MNL"},"915":{"from":"MNL","to":"SIN"},"922":{"from":"SIN","to":"SUB"},"923":{"from":"SUB","to":"SIN"},"934":{"from":"SIN","to":"DPS"},"935":{"from":"DPS","to":"SIN"},"936":{"from":"SIN","to":"DPS"},"937":{"from":"DPS","to":"SIN"},"938":{"from":"SIN","to":"DPS"},"939":{"from":"DPS","to":"SIN"},"944":{"from":"SIN","to":"DPS"},"945":{"from":"DPS","to":"SIN"},"950":{"from":"SIN","to":"CGK"},"953":{"from":"CGK","to":"SIN"},"952":{"from":"SIN","to":"CGK"},"955":{"from":"CGK","to":"SIN"},"956":{"from":"SIN","to":"CGK"},"957":{"from":"CGK","to":"SIN"},"958":{"from":"SIN","to":"CGK"},"959":{"from":"CGK","to":"SIN"},"960":{"from":"SIN","to":"CGK"},"961":{"from":"CGK","to":"SIN"},"962":{"from":"SIN","to":"CGK"},"963":{"from":"CGK","to":"SIN"},"964":{"from":"SIN","to":"CGK"},"965":{"from":"CGK","to":"SIN"},"968":{"from":"SIN","to":"CGK"},"951":{"from":"CGK","to":"SIN"}};
        const delayCodes = {"ATC Delay Codes":{"Departure":{"101":"Airport operations hours restriction","102":"Flight Plan not filed","103":"Refile flight plan due route change","104":"Slot time","105":"Late ATC clearance","106":"Flight level not available","107":"Takeoff time constraint","108":"Waypoint time constraint","109":"Departure sequencing due earlier traffic","110":"Start/Push-back sequencing due apron congestion","111":"Long Push back","112":"Long taxi-out","113":"Holding due ground traffic, dep/arr traffic, etc","115":"Delay due to gate-hold procedures","116":"TSAT Delay (A-CDM)"},"Enroute":{"221":"En-route re-routing","222":"En-route holding","223":"En-route speed constraint/control","224":"En-route flight level restriction"},"Arrival":{"331":"Arrival speed control","332":"Radar vector for arrival sequencing","333":"Arrival holding","334":"Instrument let-down and approach","335":"Approach sequencing","336":"Change runway","337":"Reciprocal runway in use","338":"Long taxi-in","339":"Holding for parking bay"},"Others":{"500":"Other ATC Delays (with written explanation)"}},"Non-ATC Departure Delay Codes":{"Passenger Services":{"PA":"SQ DCS IT system related","PB":"Awaiting Deportee","PD":"Late acceptance of pax","PE":"Check in error","PI":"Pax reported late for boarding","PJ":"Pax searching for missing property","PK":"Verifying number of pax","PL":"Late flight closure","PM":"Pax Convenience","PN":"Awaiting connecting pax/bge","PO":"Sorting out overbookings","PP":"Pax not seated for departure","PQ":"ICAO Annex 17 offloading of pax/bge","PR":"Handling dissatisfied pax","PS":"Pax receiving medical attention","PT":"Pax decided not to travel","PU":"Boarding congestion","PV":"Awaiting VIP","PW":"Verifying baggage","PY":"Sorting out seating discrepancy","PZ":"Manual check in exercise","PX":"WCHR/MAAS requirements"},"Cargo / Mail":{"CC":"Late acceptance of cargo","CD":"Documentation error","CL":"Late completion of cargo loading","CO":"Offloading cargo","CP":"Late positioning of cargo","CU":"Incorrect build up of ULDS","CX":"Not specified above"},"Acft And Ramp Handling":{"GA":"Late posn of acft due engineering","GB":"Catering","GC":"Late completion of acft cleaning","GD":"Late completion of loadsheet","GE":"Loading equipment u/s","GF":"Refuelling","GG":"Loadsheet error","GH":"Loading difficulties","GI":"Resolving fuel uplift discrepancy","GJ":"Refuelling - non engineering","GL":"Late completion of apron loading","GM":"Late posn of acft due apron congestion","GP":"Late reporting of crew due to transport","GR":"Retrimming acft","GS":"Remote bay handling","GT":"Tow Tug u/s","GU":"Awaiting tow tug","GW":"Late positioning due weather","GX":"Not specified above"},"Technical And Acft Equipment":{"TA":"Awaiting AOG spares","TB":"Awaiting engineering staff","TC":"Acft change","TD":"Acft defect","TE":"Engine defect","TF":"Toilet choke due FOD","TG":"APU u/s (first occurrence)","TH":"Engine start at bay due APU u/s","TM":"Late completion of hanger maintenance","TP":"Awaiting dispensation","TT":"Engineering Operational requirement (e.g. MEL)","TU":"Powered Drive Unit u/s","TV":"Cargo restrain lock missing or u/s","TW":"Wheel change","TY":"Wheel change due FOD","TX":"Not specified above"}},"Damage to Acft":{"":{"DB":"Damage due Birdstrike","DG":"Damage due ground operations","DL":"Damage due Lightning strike","DX":"Other Inflight damage"}},"Flight Operations":{"":{"FA":"Crew change","FB":"Awaiting replacement crew due FTL","FC":"Change of flight plan (initiated by crew)","FD":"Inflight diversion","FE":"Inflight diversion due medical","FF":"Tech crew operational requirement","FG":"Late boarding clearance by tech crew","FH":"Hard Landing inspection","FI":"Heavy/Overweight Landing inspection","FJ":"Crew error","FL":"Late reporting of crew due ...","FM":"Awaiting manuals or charts","FR":"Crew rest","FS":"Crew illness / medical","FT":"Rostering error","FW":"Awaiting crew from another flight","FX":"Not specified above"}}};
        
        /**
         * Main app entry point. Runs after the DOM is fully loaded.
         */
        document.addEventListener('DOMContentLoaded', async () => {
            cacheUiElements();
            initializeEventListeners();
            
            const defaultConfig = { apiKey: "AIzaSyD56g-MYRr6em682dDNA9ahAtdo-JLugfI", authDomain: "flight-log-3aa33.firebaseapp.com", projectId: "flight-log-3aa33", storageBucket: "flight-log-3aa33.appspot.com", messagingSenderId: "160744126033", appId: "1:160744126033:web:ec744ad18373aeed496a70" };
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultConfig;
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Enable offline persistence for Firestore
                await enableIndexedDbPersistence(db);

                // Handle authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        ui.containers.mainApp.style.display = 'block';
                        ui.userIdDisplay.textContent = `User: ${user.uid.substring(0, 6)}`;
                        flightLogDocRef = doc(db, 'artifacts', appId, 'users', userId, 'flightlogs', 'data');
                        attachFirestoreListener();
                    } else {
                       // User is signed out, attempt to sign in
                       try {
                           if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                               await signInWithCustomToken(auth, __initial_auth_token);
                           } else {
                               await signInAnonymously(auth);
                           }
                       } catch (error) {
                           // This catch block is crucial for offline-first functionality
                           console.error("Sign-in failed (likely offline or restricted):", error);
                           ui.userIdDisplay.textContent = "Offline Mode";
                           ui.containers.mainApp.style.display = 'block';
                           loadFromLocalStorage(); // Fallback to local storage
                       }
                    }
                });

            } catch (error) { 
                console.error("Firebase Initialization Failed. App may not function correctly.", error); 
                // Fallback for catastrophic failure
                ui.userIdDisplay.textContent = "Offline Mode (Error)";
                ui.containers.mainApp.style.display = 'block';
                loadFromLocalStorage();
            }
        });

        /**
         * Caches all frequently accessed DOM elements into the `ui` object.
         */
        function cacheUiElements() {
            ui = {
                inputs: {
                    flightNumber: document.getElementById('flightNumber'), date: document.getElementById('date'), from: document.getElementById('from'), to: document.getElementById('to'), registration: document.getElementById('registration'), report: document.getElementById('report'), depGate: document.getElementById('depGate'),
                    cic: document.getElementById('cic'), fo: document.getElementById('fo'),
                    out: document.getElementById('out'), taxi: document.getElementById('taxi'), off: document.getElementById('off'), on: document.getElementById('on'), in: document.getElementById('in'), std: document.getElementById('std'), eft: document.getElementById('eft'), sta: document.getElementById('sta'),
                    fromTz: document.getElementById('from-tz'), toTz: document.getElementById('to-tz'),
                    pln: document.getElementById('pln'), ezfw1: document.getElementById('ezfw1'), ezfw2: document.getElementById('ezfw2'), azfw: document.getElementById('azfw'),
                    fuel: document.getElementById('fuel'), burn: document.getElementById('burn'), altn: document.getElementById('altn'), thirtyMin: document.getElementById('thirtyMin'), cont: document.getElementById('cont'),
                    crzWind: document.getElementById('crzWind'), crzTemp: document.getElementById('crzTemp'), 
                    opti1: document.getElementById('opti1'), opti2: document.getElementById('opti2'), apd: document.getElementById('apd'),
                    afir: document.getElementById('afir'), notam: document.getElementById('notam'), defects: document.getElementById('defects'), remarks: document.getElementById('remarks')
                },
                buttons: {
                    crzTempToggle: document.getElementById('crzTempToggle'),
                    signOut: document.getElementById('sign-out-btn'),
                    exportPdf: document.getElementById('export-pdf-btn'),
                    clearSector: document.getElementById('clear-sector-btn'),
                    clearAll: document.getElementById('clear-all-btn'),
                },
                labels: { date: document.getElementById('date-label'), plw: document.getElementById('plw-label') },
                calculated: {
                    ddd: document.getElementById('ddd'), cddd: document.getElementById('cddd'), addd: document.getElementById('addd'), tod: document.getElementById('tod'), tid: document.getElementById('tid'), aaa: document.getElementById('aaa'), caaa: document.getElementById('caaa'), aaaa: document.getElementById('aaaa'),
                    stdl: document.getElementById('stdl'), stal: document.getElementById('stal'),
                    aft: document.getElementById('aft'), aftd: document.getElementById('aftd'), blk: document.getElementById('blk'), abt: document.getElementById('abt'), abtd: document.getElementById('abtd'),
                    mzfw: document.getElementById('mzfw'), mtow: document.getElementById('mtow'), mlw: document.getElementById('mlw'),
                    ptow: document.getElementById('ptow'), plw: document.getElementById('plw'), egt: document.getElementById('egt'),
                    conseqAvail: document.getElementById('conseq-avail-group')
                },
                containers: {
                    mainApp: document.getElementById('main-app'),
                    flightDataSection: document.getElementById('flight-data-section')
                },
                toolbar: { sectorButtons: document.querySelectorAll('.sector-btn') },
                delay: { container: document.getElementById('delay-codes-container'), quickRefContainer: document.getElementById('quick-ref-delays-container') },
                userIdDisplay: document.getElementById('user-id-display'),
                modals: {
                    afir: { container: document.getElementById('afir-modal'), textarea: document.getElementById('afir-textarea') },
                    notam: { container: document.getElementById('notam-modal'), textarea: document.getElementById('notam-textarea') },
                    defects: { container: document.getElementById('defects-modal'), textarea: document.getElementById('defects-textarea') }
                }
            };
        }

        /**
         * Sets up all event listeners for UI elements.
         */
        function initializeEventListeners() {
            // Standard input listeners
            Object.keys(ui.inputs).forEach(key => {
                const el = ui.inputs[key];
                if (el) {
                    el.addEventListener('input', (e) => handleInputChange(key, e.target));
                    el.addEventListener('blur', (e) => handleInputBlur(key, e.target));
                    if (el.tagName !== 'TEXTAREA') { // Don't auto-select in textareas
                        el.addEventListener('focus', (e) => e.target.select());
                        el.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.target.blur(); });
                    }
                }
            });

            // Specific element listeners
            ui.labels.date.addEventListener('click', setTomorrowDate);
            ui.buttons.crzTempToggle.addEventListener('click', toggleCrzTempSign);
            ui.toolbar.sectorButtons.forEach(btn => btn.addEventListener('click', () => switchSector(parseInt(btn.dataset.sector, 10))));
            
            // Toolbar action buttons
            ui.buttons.clearSector.addEventListener('click', clearCurrentSector);
            ui.buttons.clearAll.addEventListener('click', clearAllSectors);
            ui.buttons.signOut.addEventListener('click', () => signOut(auth));
            ui.buttons.exportPdf.addEventListener('click', exportToPdf);

            // Modal listeners
            Object.keys(ui.modals).forEach(type => {
                const modal = ui.modals[type];
                ui.inputs[type].addEventListener('click', () => openModal(type));
                modal.container.querySelector('button').addEventListener('click', () => saveAndCloseModal(type));
                modal.container.addEventListener('click', (e) => { if (e.target === modal.container) modal.container.style.display = 'none'; });
            });
        }
        
        // --- Firestore & Data Persistence ---

        /**
         * Attaches a real-time listener to the user's Firestore document.
         */
        function attachFirestoreListener() {
            if (unsubscribe) unsubscribe(); // Detach any existing listener
            unsubscribe = onSnapshot(flightLogDocRef, (doc) => {
                console.log("Data received from " + (doc.metadata.fromCache ? "local cache" : "server"));
                if (doc.exists()) {
                    const data = doc.data();
                    // Ensure data structure is valid before assigning
                    flightData = Array.isArray(data.sectors) && data.sectors.length === 6 ? data.sectors : createNewFlightData();
                    currentSectorIndex = data.currentSectorIndex || 0;
                } else {
                    // Document doesn't exist, create a new one
                    flightData = createNewFlightData();
                    currentSectorIndex = 0;
                    saveToFirestore(); // This will create the initial document
                }
                loadDataForSector(currentSectorIndex);
            }, (error) => { 
                console.error("Firestore listener error, falling back to local storage:", error);
                loadFromLocalStorage();
            });
        }

        /**
         * Saves the current flight data to both local storage (as a backup) and Firestore.
         */
        async function saveToFirestore() {
            saveToLocalStorage(); // Always save to local storage as a robust fallback
            if (userId && navigator.onLine) {
                try {
                    await setDoc(flightLogDocRef, { sectors: flightData, currentSectorIndex });
                } catch (error) {
                    console.error("Error saving to Firestore: ", error);
                }
            }
        }

        /**
         * Saves the current flight data to the browser's local storage.
         */
        function saveToLocalStorage() {
            try {
                localStorage.setItem(`flightLogData_${userId || 'offline'}`, JSON.stringify({ sectors: flightData, currentSectorIndex }));
            } catch (e) {
                console.error("Could not save to local storage:", e);
            }
        }
        
        /**
         * Loads flight data from local storage. Used as a fallback when offline.
         */
        function loadFromLocalStorage() {
             try {
                const savedData = localStorage.getItem(`flightLogData_${userId || 'offline'}`);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    flightData = parsed.sectors;
                    currentSectorIndex = parsed.currentSectorIndex;
                } else {
                    flightData = createNewFlightData();
                }
            } catch (e) {
                console.error("Could not load from local storage:", e);
                flightData = createNewFlightData();
            }
            loadDataForSector(currentSectorIndex);
        }

        // --- Input Handling & Formatting ---
        
        /**
         * Handles real-time input changes for most fields.
         */
        function handleInputChange(key, target) {
            let value = target.value;
            // Apply automatic ALL CAPS formatting
            if (['from', 'to', 'registration', 'cic', 'fo', 'depGate'].includes(key)) {
                value = value.toUpperCase();
                target.value = value;
            }
            flightData[currentSectorIndex][key] = value;
            
            // Auto-focus logic
            if (key === 'crzTemp' && value.length >= 2) target.blur();

            if (key.match(/^(out|taxi|off|on|in|std|sta|eft)$/)) {
                formatTimeInput(target);
            }
            
            // Propagate values to subsequent sectors
            if (['cic', 'fo', 'registration'].includes(key)) {
                propagateValueToFutureSectors(key, value);
            }

            saveAndRecalculate();
        }

        /**
         * Handles logic when a user leaves (blurs) an input field.
         */
        function handleInputBlur(key, target) {
            const value = target.value.toUpperCase();
            flightData[currentSectorIndex][key] = value;
            
            if (key === 'flightNumber') {
                const route = flightNumberRoutes[value];
                if (route) {
                    ui.inputs.from.value = route.from;
                    ui.inputs.to.value = route.to;
                    handleInputBlur('from', ui.inputs.from); // Trigger blur to update TZ
                    handleInputBlur('to', ui.inputs.to);
                }
            } else if (key === 'from' || key === 'to') {
                const tz = iataTimezones[value] || '';
                const tzEl = ui.inputs[`${key}Tz`];
                tzEl.value = tz;
                tzEl.style.display = (value === 'SIN' || !value) ? 'none' : 'block';
                flightData[currentSectorIndex][`${key}Tz`] = tz;
            } else if (key === 'apd') {
                target.value = parseFloat(value) === 0 ? '0.0' : value;
                flightData[currentSectorIndex][key] = target.value;
            } else if (key === 'registration') {
                target.value = `9V-${value}`;
                flightData[currentSectorIndex][key] = target.value;
            }

            // Auto-focus logic
            if (key === 'taxi') ui.inputs.off.focus();
            if (key === 'on') ui.inputs.in.focus();
            if (key === 'crzWind') ui.inputs.crzTemp.focus();

            // Auto-calculate report time for sector 1
            if (key === 'std' && currentSectorIndex === 0) {
                autoCalculateReportTime(value);
            }

            saveAndRecalculate();
        }

        /**
         * Formats time inputs to HH:MM format as the user types.
         */
        function formatTimeInput(target) { 
            let v = target.value.replace(/[^0-9]/g, ''); 
            if (v.length > 4) v = v.slice(0, 4); 
            target.value = v.length > 2 ? v.slice(0, 2) + ':' + v.slice(2) : v; 
            if (v.length === 4) flightData[currentSectorIndex][target.id] = target.value;
        }

        // --- UI Updates & Calculations ---

        /**
         * Populates the entire UI with data for the selected sector.
         */
        function loadDataForSector(index) {
            const data = flightData[index] || createNewSector();
            Object.keys(ui.inputs).forEach(key => {
                const el = ui.inputs[key];
                if (el.classList.contains('modal-trigger')) {
                    el.value = (data[key] || '').substring(0, 40) + ((data[key] || '').length > 40 ? '...' : '');
                } else {
                    el.value = data[key] || '';
                }
            });
            // Handle date separately to show formatted placeholder
            ui.inputs.date.value = '';
            ui.inputs.date.placeholder = formatDateForDisplay(data.date);
            
            // Update UI state
            ui.buttons.crzTempToggle.textContent = data.crzTempSign || 'M';
            ui.inputs.report.readOnly = (index === 0);
            ui.containers.flightDataSection.classList.toggle('flight-data-odd-sector', [1, 3, 5].includes(index));
            
            updateAllCalculations(); 
            updateActiveSectorButton(); 
            renderDelayCodes(); 
            renderQuickReferenceDelays();
        }
        
        /**
         * The core calculation engine. Updates all derived values on the screen.
         */
        function updateAllCalculations() {
            const data = flightData[currentSectorIndex];
            const aircraftType = getAircraftType();
            const limits = aircraftType ? aircraftLimits[aircraftType] : {};

            // Timings
            const outM = timeToMinutes(data.out), taxiM = timeToMinutes(data.taxi), offM = timeToMinutes(data.off), onM = timeToMinutes(data.on), inM = timeToMinutes(data.in);
            const stdM = timeToMinutes(data.std), staM = timeToMinutes(data.sta), eftM = timeToMinutes(data.eft);

            const tod = calculateTimeDifference(taxiM, offM), tid = calculateTimeDifference(onM, inM);
            const ddd = calculateDelay(stdM, outM), aaa = calculateDelay(staM, inM);
            const aft = calculateTimeDifference(offM, onM), abt = calculateTimeDifference(outM, inM);
            const blk = calculateTimeDifference(stdM, staM);
            
            setFieldText(ui.calculated.blk, minutesToHHMM(blk));
            setFieldText(ui.calculated.tod, tod !== null ? `Taxi-Out: ${tod}m` : '');
            setFieldText(ui.calculated.tid, tid !== null ? `Taxi-In: ${tid}m` : '');
            setFieldText(ui.calculated.aft, aft !== null ? `Actual: ${minutesToHHMM(aft)}` : '');
            setFieldText(ui.calculated.abt, abt !== null ? `Actual: ${minutesToHHMM(abt)}` : '');
            
            // Delay/Early display with colors
            displayDifference(ui.calculated.ddd, ddd, 'late', 'early');
            displayDifference(ui.calculated.aaa, aaa, 'late', 'early');
            displayDifference(ui.calculated.aftd, aft - eftM, 'longer', 'shorter');
            displayDifference(ui.calculated.abtd, abt - blk, 'longer', 'shorter');
            
            // Consequential & Additional Delays
            let cddd = 0, addd = 0, caaa = 0, aaaa = 0, consqAvail = 0;
            const prevSector = currentSectorIndex > 0 ? flightData[currentSectorIndex - 1] : null;
            if (prevSector) {
                const prevAaa = calculateDelay(timeToMinutes(prevSector.sta), timeToMinutes(prevSector.in));
                if (prevAaa > 0) consqAvail = prevAaa;
            }
            if (ddd > 0) { cddd = Math.min(ddd, consqAvail); addd = ddd - cddd; }
            if (aaa > 0) { caaa = Math.min(aaa, ddd > 0 ? ddd : 0); aaaa = aaa - caaa; }

            setFieldText(ui.calculated.cddd, cddd > 0 ? `Consq: ${cddd}m` : '');
            setFieldText(ui.calculated.addd, addd > 0 ? `Add: ${addd}m` : '');
            setFieldText(ui.calculated.caaa, caaa > 0 ? `Consq: ${caaa}m` : '');
            setFieldText(ui.calculated.aaaa, aaaa > 0 ? `Add: ${aaaa}m` : '');
            setFieldText(ui.calculated.conseqAvail, consqAvail > 0 ? `(Consq Avail: +${consqAvail}m)` : '');

            // Local times
            setFieldText(ui.calculated.stdl, calculateLocalTime(stdM, data.fromTz));
            setFieldText(ui.calculated.stal, calculateLocalTime(staM, data.toTz));

            // Weights
            const zfw = parseFloat(data.azfw) || parseFloat(data.ezfw2) || parseFloat(data.ezfw1) || 0;
            const fuel = parseFloat(data.fuel) || 0, burn = parseFloat(data.burn) || 0;
            const ptow = (zfw && fuel) ? zfw + fuel : 0;
            const plw = (zfw && fuel && burn) ? zfw + fuel - burn - 0.3 : 0;
            
            setFieldText(ui.calculated.ptow, ptow > 0 ? ptow.toFixed(1) : '');
            setFieldText(ui.calculated.plw, plw > 0 ? plw.toFixed(1) : '');
            setFieldText(ui.calculated.mzfw, limits.MZFW ? `MZFW ${limits.MZFW}` : '');
            setFieldText(ui.calculated.mtow, limits.MTOW ? `MTOW ${limits.MTOW}` : '');
            setFieldText(ui.calculated.mlw, limits.MLW ? `MLW ${limits.MLW}` : '');
            setFieldText(ui.calculated.egt, limits.EGT || '');

            // PLW and MLW color coding for exceeding limits
            const plwLimit = aircraftType === 'MAX' ? 68.5 : (aircraftType === 'NG' ? 65.3 : Infinity);
            const plwExceeded = plw >= plwLimit;
            ui.calculated.plw.style.color = plwExceeded ? 'var(--red-color)' : 'var(--text-color)';
            ui.labels.plw.style.color = plwExceeded ? 'var(--red-color)' : 'var(--text-color)';
            ui.calculated.mlw.style.color = (limits.MLW && plw > limits.MLW) ? 'var(--red-color)' : 'var(--subtle-text-color)';

            // OPTI formatting
            const opti1 = data.opti1 || '', opti2 = data.opti2 || '';
            setFieldText(ui.inputs.opti1, opti1.toLowerCase() === 'nil' ? 'NIL' : (opti1.length === 6 ? `${opti1.substring(0,3)} / FL${opti1.substring(3)}` : opti1));
            setFieldText(ui.inputs.opti2, opti2.toLowerCase() === 'nil' ? 'NIL' : (opti2.length === 5 ? `${opti2.substring(0,3)} / M.${opti2.substring(3)}` : opti2));
        }

        // --- Utility & Helper Functions ---

        function timeToMinutes(timeStr) { if (!timeStr || !timeStr.includes(':')) return null; const [h, m] = timeStr.split(':').map(Number); return isNaN(h) || isNaN(m) ? null : h * 60 + m; }
        function minutesToHHMM(totalMinutes) { if (totalMinutes === null || isNaN(totalMinutes)) return ''; const h = Math.floor(totalMinutes/60).toString().padStart(2,'0'); const m = Math.round(totalMinutes%60).toString().padStart(2,'0'); return `${h}:${m}`; }
        function calculateTimeDifference(startM, endM) { if (startM === null || endM === null) return null; let diff = endM - startM; return diff < 0 ? diff + 1440 : diff; } // Handles overnight
        function calculateDelay(schedM, actualM) { if (schedM === null || actualM === null) return null; let diff = actualM - schedM; if (diff > 720) diff -= 1440; if (diff < -720) diff += 1440; return diff; }
        function calculateLocalTime(utcM, offset) { if (utcM === null || !offset) return ''; const o = parseFloat(offset) * 60; return isNaN(o) ? '' : `${minutesToHHMM((utcM + o + 1440) % 1440)} LT`; }
        function formatDateForDisplay(dStr) { if (!dStr) return ''; const d = new Date(dStr + 'T00:00:00'); return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', weekday: 'short', timeZone: 'UTC' }); }
        function setTomorrowDate() { const t = new Date(); t.setDate(t.getDate() + 1); const y = t.getFullYear(), m = (t.getMonth()+1).toString().padStart(2,'0'), d = t.getDate().toString().padStart(2,'0'); const dateValue = `${y}-${m}-${d}`; flightData[currentSectorIndex].date = dateValue; propagateValueToFutureSectors('date', dateValue); saveAndRecalculate(); loadDataForSector(currentSectorIndex); }
        function setFieldText(el, text, color) { if(el) { el.textContent = text; if(color) el.style.color = color; } }
        function displayDifference(el, diff, positiveText, negativeText) { if (diff > 0) setFieldText(el, `${diff}m ${positiveText}`, 'var(--red-color)'); else if (diff < 0) setFieldText(el, `${-diff}m ${negativeText}`, 'var(--green-color)'); else setFieldText(el, ''); }
        function propagateValueToFutureSectors(key, val) { for (let i = currentSectorIndex + 1; i < 6; i++) flightData[i][key] = val; }
        function autoCalculateReportTime(std) { const stdM = timeToMinutes(std); if (stdM !== null) { const rpt = minutesToHHMM((stdM - 60 + 1440) % 1440); flightData[0].report = rpt; ui.inputs.report.value = rpt; } }
        function switchSector(index) { if (currentSectorIndex !== index) { currentSectorIndex = index; loadDataForSector(index); saveToFirestore(); } }
        function getAircraftType() { const reg = (flightData[currentSectorIndex].registration || '').charAt(3); if (reg === 'B') return 'MAX'; if (reg === 'G') return 'NG'; return null; }
        function toggleCrzTempSign() { const newSign = ui.buttons.crzTempToggle.textContent === 'M' ? 'P' : 'M'; flightData[currentSectorIndex].crzTempSign = newSign; saveAndRecalculate(); loadDataForSector(currentSectorIndex); }
        function clearCurrentSector() { if (confirm("Clear all data for this sector?")) { const {cic, fo, registration, date} = flightData[currentSectorIndex]; flightData[currentSectorIndex] = {...createNewSector(), cic, fo, registration, date}; saveAndRecalculate(); loadDataForSector(currentSectorIndex); } }
        function clearAllSectors() { if (confirm("Clear ALL data for every sector?")) { flightData = createNewFlightData(); currentSectorIndex = 0; saveAndRecalculate(); loadDataForSector(0); } }
        function updateActiveSectorButton() { ui.toolbar.sectorButtons.forEach((btn, i) => btn.classList.toggle('active', i === currentSectorIndex)); }
        
        // --- Data Structure Creators ---
        function createNewFlightData() { return Array(6).fill(null).map(() => createNewSector()); }
        function createNewSector() { return { flightNumber: '', date: '', from: '', to: '', fromTz: '', toTz: '', cic: '', fo: '', registration: '', report: '', depGate: '', out: '', taxi: '', off: '', on: '', in: '', std: '', eft: '', sta: '', pln: '', ezfw1: '', ezfw2: '', azfw: '', fuel: '', burn: '', altn: '', thirtyMin: '', cont: '', crzWind: '', crzTemp: '', crzTempSign: 'M', opti1: '', opti2: '', apd: '', afir: '', notam: '', defects: '', remarks: '' }; }

        // --- Modals & Delay Code Rendering ---
        function renderDelayCodes() { ui.delay.container.innerHTML = Object.entries(delayCodes).map(([cat, subs]) => `<details><summary>${cat}</summary>${Object.entries(subs).map(([sub, codes]) => (sub ? `<div><strong>${sub}</strong></div>` : '') + Object.entries(codes).map(([code, desc]) => `<div class="delay-code-item">${code} - ${desc}</div>`).join('')).join('')}</details>`).join(''); }
        function renderQuickReferenceDelays() { const quickRef = { PU: 'Boarding congestion', PN: 'Awaiting connecting pax/bge', 113: 'Holding due ground traffic...', 112: 'Long taxi-out', 331: 'Arrival speed control', 332: 'Radar vector for arrival...', PQ: 'ICAO Annex 17 offloading...' }; ui.delay.quickRefContainer.innerHTML = Object.entries(quickRef).map(([code, desc]) => `<div class="delay-code-item">${code} - ${desc}</div>`).join(''); }
        function openModal(type) { const modal = ui.modals[type]; modal.textarea.value = flightData[currentSectorIndex][type] || ''; modal.container.style.display = 'block'; modal.textarea.focus(); }
        function saveAndCloseModal(type) { const modal = ui.modals[type]; flightData[currentSectorIndex][type] = modal.textarea.value; modal.container.style.display = 'none'; saveAndRecalculate(); loadDataForSector(currentSectorIndex); }

        // --- PDF Export ---
        function exportToPdf() {
            const sectorsWithData = flightData.filter(s => s && s.flightNumber);
            if (sectorsWithData.length === 0) { alert("No flight data to export."); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const margin = 30, valueMargin = 200;
            let yPos = margin;
            
            const checkPageBreak = (neededHeight = 20) => { if (yPos > pageH - margin - neededHeight) { doc.addPage(); yPos = margin; } };
            const printField = (label, value) => { if (!value) return; checkPageBreak(); doc.setFontSize(9).setTextColor("#a0a0a0").text(label, margin, yPos); doc.setFontSize(11).setTextColor("#FFFFFF").text(String(value), valueMargin, yPos); yPos += 18; };
            
            doc.setFillColor("#000000").rect(0, 0, pageW, pageH, 'F');
            const firstSector = sectorsWithData[0];
            doc.setFont('helvetica', 'bold').setFontSize(20).setTextColor("#FFFFFF").text("FLIGHT LOG SUMMARY", pageW / 2, yPos, { align: 'center' });
            yPos += 25;
            doc.setFont('helvetica', 'normal').setFontSize(14).text(`${firstSector.flightNumber} / ${formatDateForDisplay(firstSector.date)}`, pageW / 2, yPos, { align: 'center' });
            yPos += 30;
            
            sectorsWithData.forEach((s, index) => {
                checkPageBreak(50);
                doc.setFillColor("#007aff").roundedRect(margin - 10, yPos - 14, pageW - (margin - 10)*2, 20, 5, 5, 'F');
                doc.setFont('helvetica', 'bold').setFontSize(12).setTextColor("#FFFFFF").text(`SECTOR ${index + 1}: ${s.flightNumber} ${s.from}-${s.to}`, margin, yPos);
                yPos += 30;

                const zfw = parseFloat(s.azfw) || parseFloat(s.ezfw2) || parseFloat(s.ezfw1) || 0;
                const fuel = parseFloat(s.fuel) || 0, burn = parseFloat(s.burn) || 0;

                printField("REGISTRATION", s.registration);
                printField("CREW", `${s.cic} / ${s.fo}`);
                printField("TIMINGS (OUT/OFF/ON/IN)", `${s.out} / ${s.off} / ${s.on} / ${s.in}`);
                printField("SCHEDULE (STD/STA)", `${s.std} / ${s.sta}`);
                printField("ACTUAL FLIGHT TIME", minutesToHHMM(calculateTimeDifference(timeToMinutes(s.off), timeToMinutes(s.on))));
                printField("ACTUAL BLOCK TIME", minutesToHHMM(calculateTimeDifference(timeToMinutes(s.out), timeToMinutes(s.in))));
                printField("ZERO FUEL WT (AZFW)", zfw ? zfw.toFixed(1) : '');
                printField("TAKE-OFF WT (PTOW)", (zfw && fuel) ? (zfw + fuel).toFixed(1) : '');
                printField("LANDING WT (PLW)", (zfw && fuel && burn) ? (zfw + fuel - burn - 0.3).toFixed(1) : '');
                printField("FUEL (FOB/BURN)", `${s.fuel} / ${s.burn}`);
                
                if (s.defects) printField("DEFECTS", s.defects);
                if (s.remarks) printField("REMARKS", s.remarks);
                yPos += 15;
            });
            
            doc.save(`${firstSector.flightNumber}-${firstSector.date}.pdf`);
        }

    </script>
</body>
</html>



